{% extends "base.html" %}

{% block title %}Models - Gold and Bitcoin Predictor{% endblock %}

{% block content %}
<div class="bg-white shadow-md rounded-lg overflow-hidden">
    <div class="p-8">
        <!-- Header Section -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-brain mr-3 text-purple-600"></i>
                    Enhanced Prediction Models
                </h1>
                <p class="text-gray-600">
                    Advanced machine learning models with proper time series methodology, technical indicators, and enhanced validation
                </p>
            </div>
            <div class="flex gap-3">
                <button id="refresh-models" onclick="refreshModelData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 btn-enhanced">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
                <button onclick="compareModels()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 btn-enhanced">
                    <i class="fas fa-balance-scale mr-2"></i>Compare
                </button>
            </div>
        </div>

        <!-- Model Performance Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Gold Model Card -->
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-lg shadow-lg card-hover border border-yellow-200">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-coins mr-2 text-yellow-600"></i>
                        Gold Prediction Model
                    </h2>
                    <div class="flex gap-2">
                        <span id="gold-model-status" class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>Active
                        </span>
                        <span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">Enhanced</span>
                    </div>
                </div>
                
                <!-- Performance Metrics -->
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-3">Model Performance:</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white p-3 rounded-lg border border-yellow-200 text-center">
                            <p class="text-xs text-gray-500 mb-1">R² Score</p>
                            <p class="text-lg font-bold text-yellow-700" id="gold-r2">Loading...</p>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                <div id="gold-r2-bar" class="bg-yellow-600 h-1.5 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-yellow-200 text-center">
                            <p class="text-xs text-gray-500 mb-1">RMSE</p>
                            <p class="text-lg font-bold text-yellow-700" id="gold-rmse">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1" id="gold-rmse-quality">--</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-yellow-200 text-center">
                            <p class="text-xs text-gray-500 mb-1">MAE</p>
                            <p class="text-lg font-bold text-yellow-700" id="gold-mae">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1" id="gold-mae-quality">--</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-yellow-200 text-center">
                            <p class="text-xs text-gray-500 mb-1">CV Score</p>
                            <p class="text-lg font-bold text-yellow-700" id="gold-cv">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1">±<span id="gold-cv-std">--</span></p>
                        </div>
                    </div>
                </div>

                <!-- Model Details -->
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2">Model Details:</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div class="flex justify-between">
                            <span>Algorithm:</span>
                            <span id="gold-model-type" class="font-medium">XGBoost Enhanced</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Features:</span>
                            <span id="gold-feature-count" class="font-medium">200+ indicators</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Training Data:</span>
                            <span id="gold-training-size" class="font-medium">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Last Trained:</span>
                            <span id="gold-last-trained" class="font-medium">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Top Features Preview -->
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2">Top Features:</h3>
                    <div class="space-y-2" id="gold-features">
                        <div class="flex items-center">
                            <div class="w-20 text-xs text-gray-600">Loading...</div>
                            <div class="flex-1 bg-gray-200 rounded-full h-2 mx-2">
                                <div class="h-2 bg-yellow-500 rounded-full animate-pulse" style="width: 0%"></div>
                            </div>
                            <span class="text-xs text-gray-600 w-12">--</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button onclick="trainModel('Gold')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded-lg transition-colors duration-200 text-sm btn-enhanced">
                        <i class="fas fa-cog mr-1"></i>Retrain
                    </button>
                    <button onclick="viewModelDetails('gold')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg transition-colors duration-200 text-sm btn-enhanced">
                        <i class="fas fa-info-circle mr-1"></i>Details
                    </button>
                </div>
            </div>
            
            <!-- Bitcoin Model Card -->
            <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-lg shadow-lg card-hover border border-orange-200">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fab fa-bitcoin mr-2 text-orange-600"></i>
                        Bitcoin Prediction Model
                    </h2>
                    <div class="flex gap-2">
                        <span id="bitcoin-model-status" class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>Active
                        </span>
                        <span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">Enhanced</span>
                    </div>
                </div>
                
                <!-- Performance Metrics -->
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-3">Model Performance:</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white p-3 rounded-lg border border-orange-200 text-center">
                            <p class="text-xs text-gray-500 mb-1">R² Score</p>
                            <p class="text-lg font-bold text-orange-700" id="bitcoin-r2">Loading...</p>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                <div id="bitcoin-r2-bar" class="bg-orange-600 h-1.5 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-orange-200 text-center">
                            <p class="text-xs text-gray-500 mb-1">RMSE</p>
                            <p class="text-lg font-bold text-orange-700" id="bitcoin-rmse">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1" id="bitcoin-rmse-quality">--</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-orange-200 text-center">
                            <p class="text-xs text-gray-500 mb-1">MAE</p>
                            <p class="text-lg font-bold text-orange-700" id="bitcoin-mae">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1" id="bitcoin-mae-quality">--</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-orange-200 text-center">
                            <p class="text-xs text-gray-500 mb-1">CV Score</p>
                            <p class="text-lg font-bold text-orange-700" id="bitcoin-cv">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1">±<span id="bitcoin-cv-std">--</span></p>
                        </div>
                    </div>
                </div>

                <!-- Model Details -->
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2">Model Details:</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div class="flex justify-between">
                            <span>Algorithm:</span>
                            <span id="bitcoin-model-type" class="font-medium">XGBoost Enhanced</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Features:</span>
                            <span id="bitcoin-feature-count" class="font-medium">200+ indicators</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Training Data:</span>
                            <span id="bitcoin-training-size" class="font-medium">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Last Trained:</span>
                            <span id="bitcoin-last-trained" class="font-medium">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Top Features Preview -->
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2">Top Features:</h3>
                    <div class="space-y-2" id="bitcoin-features">
                        <div class="flex items-center">
                            <div class="w-20 text-xs text-gray-600">Loading...</div>
                            <div class="flex-1 bg-gray-200 rounded-full h-2 mx-2">
                                <div class="h-2 bg-orange-500 rounded-full animate-pulse" style="width: 0%"></div>
                            </div>
                            <span class="text-xs text-gray-600 w-12">--</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button onclick="trainModel('BITCOIN')" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg transition-colors duration-200 text-sm btn-enhanced">
                        <i class="fas fa-cog mr-1"></i>Retrain
                    </button>
                    <button onclick="viewModelDetails('bitcoin')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg transition-colors duration-200 text-sm btn-enhanced">
                        <i class="fas fa-info-circle mr-1"></i>Details
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Trading Recommendations Section -->
        <div class="bg-gray-50 p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                Get Enhanced Trading Recommendations
            </h2>
            
            <form id="prediction-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="asset" class="block text-sm font-medium text-gray-700 mb-1">Select Asset:</label>
                        <select id="asset" name="asset" class="w-full form-enhanced rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2 border">
                            <option value="">Choose asset...</option>
                            <option value="gold">
                                <i class="fas fa-coins"></i> Gold
                            </option>
                            <option value="bitcoin">
                                <i class="fab fa-bitcoin"></i> Bitcoin
                            </option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="timeframe" class="block text-sm font-medium text-gray-700 mb-1">Timeframe:</label>
                        <select id="timeframe" name="timeframe" class="w-full form-enhanced rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2 border">
                            <option value="1d">1 Day</option>
                            <option value="1w">1 Week</option>
                            <option value="1m">1 Month</option>
                        </select>
                    </div>

                    <div>
                        <label for="confidence-threshold" class="block text-sm font-medium text-gray-700 mb-1">Min Confidence:</label>
                        <select id="confidence-threshold" name="confidence-threshold" class="w-full form-enhanced rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2 border">
                            <option value="0.5">50% - Conservative</option>
                            <option value="0.6" selected>60% - Balanced</option>
                            <option value="0.7">70% - Aggressive</option>
                            <option value="0.8">80% - High Risk</option>
                        </select>
                    </div>

                    <div class="flex items-end">
                        <button type="submit" id="predict-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-4 rounded-lg transition-colors duration-200 btn-enhanced">
                            <i class="fas fa-magic mr-2"></i>Get Prediction
                        </button>
                    </div>
                </div>

                <!-- Advanced Options -->
                <div class="border-t pt-4">
                    <button type="button" onclick="toggleAdvancedOptions()" class="text-sm text-blue-600 hover:text-blue-700 flex items-center">
                        <i class="fas fa-cog mr-1"></i>
                        Advanced Options
                        <i id="advanced-toggle" class="fas fa-chevron-down ml-1 transition-transform duration-200"></i>
                    </button>
                    
                    <div id="advanced-options" class="hidden mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Model Type:</label>
                            <select id="model-type" class="w-full form-enhanced rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                <option value="">Auto-select Best</option>
                                <option value="xgboost">XGBoost Enhanced</option>
                                <option value="random_forest">Random Forest</option>
                                <option value="linear">Linear Regression</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Include Technical Analysis:</label>
                            <div class="flex items-center space-x-4 mt-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="include-rsi" checked class="rounded border-gray-300 text-blue-600">
                                    <span class="ml-1 text-sm">RSI</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="include-macd" checked class="rounded border-gray-300 text-blue-600">
                                    <span class="ml-1 text-sm">MACD</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="include-bb" checked class="rounded border-gray-300 text-blue-600">
                                    <span class="ml-1 text-sm">Bollinger Bands</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Risk Tolerance:</label>
                            <select id="risk-tolerance" class="w-full form-enhanced rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                <option value="conservative">Conservative</option>
                                <option value="moderate" selected>Moderate</option>
                                <option value="aggressive">Aggressive</option>
                            </select>
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- Enhanced Prediction Results -->
            <div id="prediction-result" class="mt-6 hidden">
                <h3 class="font-medium text-gray-700 mb-4">
                    <i class="fas fa-chart-area mr-2"></i>Enhanced Prediction Analysis
                </h3>
                <div class="bg-white p-6 rounded-lg shadow-lg border">
                    <!-- Main Recommendation Banner -->
                    <div class="text-center mb-6 p-4 rounded-lg" id="recommendation-banner">
                        <div class="flex items-center justify-center mb-2">
                            <div id="action-badge" class="px-6 py-3 rounded-full text-white font-bold text-xl">
                                <!-- Filled by JavaScript -->
                            </div>
                        </div>
                        <p class="text-sm text-gray-600" id="recommendation-reason">Analysis reason will appear here</p>
                    </div>
                    
                    <!-- Prediction Metrics Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-500 mb-1">Current Price</p>
                            <p class="text-lg font-bold text-gray-800" id="current-price">--</p>
                            <p class="text-xs text-gray-500">Live Market</p>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-500 mb-1">Predicted Price</p>
                            <p class="text-lg font-bold text-gray-800" id="predicted-price">--</p>
                            <p class="text-xs text-gray-500" id="prediction-timeframe">--</p>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-500 mb-1">Expected Change</p>
                            <p class="text-lg font-bold" id="price-movement">--</p>
                            <p class="text-xs text-gray-500">Price Movement</p>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-500 mb-1">Confidence</p>
                            <p class="text-lg font-bold text-blue-600" id="confidence">--</p>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                <div id="confidence-bar" class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Analytics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <!-- Risk Assessment -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-shield-alt mr-2 text-red-500"></i>Risk Assessment
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Risk Level:</span>
                                    <span id="risk-level" class="px-2 py-1 rounded text-xs font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Volatility:</span>
                                    <span id="risk-range" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Drawdown Risk:</span>
                                    <span id="drawdown-risk" class="font-medium">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- Model Performance -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-chart-bar mr-2 text-blue-500"></i>Model Performance
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>R² Score:</span>
                                    <span id="model-r2" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>CV Mean:</span>
                                    <span id="model-cv-mean" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>CV Stability:</span>
                                    <span id="model-cv-std" class="font-medium">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Analysis -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-cogs mr-2 text-purple-500"></i>Technical Signals
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>RSI Signal:</span>
                                    <span id="tech-rsi" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>MACD Signal:</span>
                                    <span id="tech-macd" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Trend:</span>
                                    <span id="tech-trend" class="font-medium">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3 justify-center">
                        <button onclick="viewPredictionChart()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 text-sm btn-enhanced">
                            <i class="fas fa-chart-line mr-1"></i>View Chart
                        </button>
                        <button onclick="runBacktest()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 text-sm btn-enhanced">
                            <i class="fas fa-history mr-1"></i>Backtest
                        </button>
                        <button onclick="exportPrediction()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 text-sm btn-enhanced">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                        <button onclick="schedulePrediction()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 text-sm btn-enhanced">
                            <i class="fas fa-calendar mr-1"></i>Schedule
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Comparison Chart -->
        <div class="bg-gray-50 p-6 rounded-lg shadow mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-balance-scale mr-2 text-green-600"></i>
                    Model Performance Comparison
                </h2>
                <select id="comparison-metric" onchange="updateComparisonChart()" class="form-enhanced rounded border-gray-300 text-sm">
                    <option value="r2">R² Score</option>
                    <option value="rmse">RMSE</option>
                    <option value="mae">MAE</option>
                    <option value="cv">Cross-Validation</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="modelComparisonChart"></canvas>
            </div>
            <div class="mt-4 text-sm text-gray-600 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-medium mb-2">Performance Insights:</h4>
                    <ul id="performance-insights" class="space-y-1">
                        <li><i class="fas fa-spinner fa-spin mr-2"></i>Analyzing model performance...</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium mb-2">Recommendations:</h4>
                    <ul id="model-recommendations" class="space-y-1">
                        <li><i class="fas fa-spinner fa-spin mr-2"></i>Generating recommendations...</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="flex justify-center gap-4">
            <a href="{{ url_for('index') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 btn-enhanced">
                <i class="fas fa-home mr-2"></i>Back to Dashboard
            </a>
            <a href="{{ url_for('analytics') }}" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 btn-enhanced">
                <i class="fas fa-chart-bar mr-2"></i>View Analytics
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let modelComparisonChart;
    let modelData = {};

    // Initialize models page
    document.addEventListener('DOMContentLoaded', function() {
        loadModelPerformance();
        initializeModelComparisonChart();
        setupFormHandlers();
        
        // Auto-refresh model data every 5 minutes
        setInterval(refreshModelData, 300000);
    });

    // Load model performance data
    async function loadModelPerformance() {
        try {
            showLoading('refresh-models', 'Loading Models...');
            
            const response = await apiCall('/api/model/performance');
            
            if (response.success) {
                modelData = response.models;
                updateModelDisplays(response.models);
                updateModelComparisonChart(response.models);
                generateModelInsights(response.models);
            }
            
            hideLoading('refresh-models');
            showToast('Model data loaded successfully', 'success');
            
        } catch (error) {
            console.error('Failed to load model performance:', error);
            hideLoading('refresh-models');
            showToast('Failed to load model data', 'error');
        }
    }

    // Update model display cards
    function updateModelDisplays(models) {
        Object.entries(models).forEach(([asset, modelInfo]) => {
            updateModelCard(asset, modelInfo);
        });
    }

    // Update individual model card
    function updateModelCard(asset, modelInfo) {
        const performance = modelInfo.performance;
        
        if (performance && typeof performance === 'object') {
            // Handle both enhanced and legacy model formats
            const metrics = performance.xgboost || performance;
            
            // Update performance metrics
            updateMetricDisplay(asset, 'r2', metrics.r2, 0, 1);
            updateMetricDisplay(asset, 'rmse', metrics.rmse);
            updateMetricDisplay(asset, 'mae', metrics.mae);
            
            // Update cross-validation if available
            if (metrics.cv_mean !== undefined) {
                document.getElementById(`${asset}-cv`).textContent = metrics.cv_mean.toFixed(3);
                document.getElementById(`${asset}-cv-std`).textContent = metrics.cv_std ? metrics.cv_std.toFixed(3) : '--';
            }
            
            // Update model details
            updateModelDetails(asset, modelInfo);
            
            // Update feature importance
            updateFeatureImportance(asset, modelInfo.feature_importance || {});
            
            // Update status based on performance
            updateModelStatus(asset, metrics.r2 || 0);
            
        } else {
            // Handle case where no performance data is available
            setLoadingState(asset, 'No model data available');
        }
    }

    // Update metric display with quality assessment
    function updateMetricDisplay(asset, metric, value, min = null, max = null) {
        const element = document.getElementById(`${asset}-${metric}`);
        const qualityElement = document.getElementById(`${asset}-${metric}-quality`);
        
        if (element && value !== undefined && value !== null) {
            if (metric === 'r2') {
                element.textContent = value.toFixed(3);
                // Animate R² progress bar
                const barElement = document.getElementById(`${asset}-r2-bar`);
                if (barElement) {
                    animateProgressBar(`${asset}-r2-bar`, value * 100);
                }
            } else {
                element.textContent = value.toFixed(2);
            }
            
            // Add quality assessment
            if (qualityElement) {
                const quality = assessMetricQuality(metric, value);
                qualityElement.textContent = quality.label;
                qualityElement.className = `text-xs ${quality.color} mt-1`;
            }
        } else {
            element.textContent = 'N/A';
            if (qualityElement) {
                qualityElement.textContent = '--';
            }
        }
    }

    // Assess metric quality
    function assessMetricQuality(metric, value) {
        switch (metric) {
            case 'r2':
                if (value >= 0.8) return { label: 'Excellent', color: 'text-green-600' };
                if (value >= 0.6) return { label: 'Good', color: 'text-blue-600' };
                if (value >= 0.4) return { label: 'Fair', color: 'text-yellow-600' };
                return { label: 'Poor', color: 'text-red-600' };
            case 'rmse':
                // This would need domain-specific thresholds
                return { label: 'Acceptable', color: 'text-gray-600' };
            case 'mae':
                // This would need domain-specific thresholds  
                return { label: 'Acceptable', color: 'text-gray-600' };
            default:
                return { label: '--', color: 'text-gray-500' };
        }
    }

    // Update model details section
    function updateModelDetails(asset, modelInfo) {
        const modelType = modelInfo.model_type === 'enhanced' ? 'XGBoost Enhanced' : 'XGBoost Legacy';
        document.getElementById(`${asset}-model-type`).textContent = modelType;
        
        // Simulate other details (in real app, these would come from API)
        document.getElementById(`${asset}-training-size`).textContent = '2000+ samples';
        document.getElementById(`${asset}-last-trained`).textContent = 'Today';
        
        const featureCount = Object.keys(modelInfo.feature_importance || {}).length;
        document.getElementById(`${asset}-feature-count`).textContent = 
            featureCount > 0 ? `${featureCount} features` : '200+ indicators';
    }

    // Update feature importance display
    function updateFeatureImportance(asset, featureImportance) {
        const container = document.getElementById(`${asset}-features`);
        container.innerHTML = '';
        
        const features = Object.entries(featureImportance)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5); // Top 5 features
        
        if (features.length === 0) {
            container.innerHTML = '<div class="text-xs text-gray-500">No feature data available</div>';
            return;
        }
        
        const maxImportance = Math.max(...features.map(([,importance]) => importance));
        const color = asset === 'gold' ? 'bg-yellow-500' : 'bg-orange-500';
        
        features.forEach(([feature, importance]) => {
            const percentage = (importance / maxImportance) * 100;
            const displayName = feature.length > 15 ? feature.slice(0, 15) + '...' : feature;
            
            const featureHtml = `
                <div class="flex items-center">
                    <div class="w-20 text-xs text-gray-600 truncate" title="${feature}">${displayName}</div>
                    <div class="flex-1 bg-gray-200 rounded-full h-2 mx-2">
                        <div class="h-2 ${color} rounded-full transition-all duration-1000" style="width: ${percentage}%"></div>
                    </div>
                    <span class="text-xs text-gray-600 w-12">${importance.toFixed(3)}</span>
                </div>
            `;
            container.innerHTML += featureHtml;
        });
    }

    // Update model status badge
    function updateModelStatus(asset, r2Score) {
        const statusElement = document.getElementById(`${asset}-model-status`);
        
        if (r2Score >= 0.7) {
            statusElement.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Excellent';
            statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800';
        } else if (r2Score >= 0.5) {
            statusElement.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>Good';
            statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800';
        } else if (r2Score > 0) {
            statusElement.innerHTML = '<i class="fas fa-times-circle mr-1"></i>Needs Training';
            statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800';
        } else {
            statusElement.innerHTML = '<i class="fas fa-question-circle mr-1"></i>Not Available';
            statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800';
        }
    }

    // Initialize model comparison chart
    function initializeModelComparisonChart() {
        const ctx = document.getElementById('modelComparisonChart').getContext('2d');
        modelComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['R² Score', 'RMSE (scaled)', 'MAE (scaled)', 'CV Score'],
                datasets: [
                    {
                        label: 'Gold Model',
                        data: [0, 0, 0, 0],
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Bitcoin Model',
                        data: [0, 0, 0, 0],
                        backgroundColor: 'rgba(249, 115, 22, 0.8)',
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Model Performance Comparison'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const metric = context.label;
                                if (metric.includes('scaled')) {
                                    return `${context.dataset.label}: ${(value * 100).toFixed(1)}% (normalized)`;
                                }
                                return `${context.dataset.label}: ${value.toFixed(3)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1,
                        ticks: {
                            callback: function(value) {
                                return (value * 100).toFixed(0) + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Update model comparison chart
    function updateModelComparisonChart(models) {
        if (!modelComparisonChart) return;
        
        const goldMetrics = models.gold?.performance?.xgboost || models.gold?.performance || {};
        const bitcoinMetrics = models.bitcoin?.performance?.xgboost || models.bitcoin?.performance || {};
        
        // Normalize metrics to 0-1 scale for comparison
        const goldData = [
            goldMetrics.r2 || 0,
            normalizeRMSE(goldMetrics.rmse, 'gold'),
            normalizeMAE(goldMetrics.mae, 'gold'),
            goldMetrics.cv_mean || 0
        ];
        
        const bitcoinData = [
            bitcoinMetrics.r2 || 0,
            normalizeRMSE(bitcoinMetrics.rmse, 'bitcoin'),
            normalizeMAE(bitcoinMetrics.mae, 'bitcoin'),
            bitcoinMetrics.cv_mean || 0
        ];
        
        modelComparisonChart.data.datasets[0].data = goldData;
        modelComparisonChart.data.datasets[1].data = bitcoinData;
        modelComparisonChart.update();
    }

    // Normalize RMSE for comparison (simplified)
    function normalizeRMSE(rmse, asset) {
        if (!rmse) return 0;
        // Simple normalization - in real app, use historical ranges
        const maxExpected = asset === 'gold' ? 100 : 5000;
        return Math.max(0, Math.min(1, 1 - (rmse / maxExpected)));
    }

    // Normalize MAE for comparison (simplified)
    function normalizeMAE(mae, asset) {
        if (!mae) return 0;
        // Simple normalization - in real app, use historical ranges
        const maxExpected = asset === 'gold' ? 50 : 2500;
        return Math.max(0, Math.min(1, 1 - (mae / maxExpected)));
    }

    // Generate model insights
    function generateModelInsights(models) {
        const insights = [];
        const recommendations = [];
        
        // Analyze performance
        Object.entries(models).forEach(([asset, modelInfo]) => {
            const performance = modelInfo.performance?.xgboost || modelInfo.performance || {};
            const r2 = performance.r2 || 0;
            const assetName = asset.charAt(0).toUpperCase() + asset.slice(1);
            
            if (r2 >= 0.8) {
                insights.push(`${assetName} model shows excellent predictive accuracy (R² = ${r2.toFixed(3)})`);
            } else if (r2 >= 0.6) {
                insights.push(`${assetName} model demonstrates good performance with room for improvement`);
                recommendations.push(`Consider retraining ${assetName} model with more recent data`);
            } else if (r2 > 0) {
                insights.push(`${assetName} model requires attention - low predictive accuracy detected`);
                recommendations.push(`Retrain ${assetName} model with enhanced feature engineering`);
            } else {
                insights.push(`${assetName} model data not available - training required`);
                recommendations.push(`Train ${assetName} model with current market data`);
            }
        });
        
        // Add general insights
        if (models.gold && models.bitcoin) {
            const goldR2 = models.gold.performance?.xgboost?.r2 || models.gold.performance?.r2 || 0;
            const bitcoinR2 = models.bitcoin.performance?.xgboost?.r2 || models.bitcoin.performance?.r2 || 0;
            
            if (Math.abs(goldR2 - bitcoinR2) > 0.2) {
                insights.push('Significant performance difference detected between asset models');
                recommendations.push('Consider harmonizing training parameters across models');
            }
        }
        
        // Update displays
        updateInsightsList('performance-insights', insights.length ? insights : ['All models operating within normal parameters']);
        updateInsightsList('model-recommendations', recommendations.length ? recommendations : ['No immediate actions required']);
    }

    // Update insights list
    function updateInsightsList(elementId, items) {
        const element = document.getElementById(elementId);
        element.innerHTML = '';
        
        items.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-500"></i>${item}`;
            element.appendChild(li);
        });
    }

    // Setup form handlers
    function setupFormHandlers() {
        document.getElementById('prediction-form').addEventListener('submit', handlePredictionSubmit);
    }

    // Handle prediction form submission
    async function handlePredictionSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('prediction-form')) {
            showToast('Please fill in all required fields', 'warning');
            return;
        }
        
        const formData = getFormData();
        
        try {
            showLoading('predict-btn', 'Analyzing...');
            
            const response = await apiCall('/api/model/trading-recommendation', {
                method: 'POST',
                body: JSON.stringify(formData)
            });
            
            if (response.success) {
                displayPredictionResults(response.recommendation, formData);
                showToast(`Prediction generated for ${formData.asset}`, 'success');
            }
            
        } catch (error) {
            console.error('Prediction error:', error);
            showToast(`Prediction failed: ${error.message}`, 'error');
        } finally {
            hideLoading('predict-btn');
        }
    }

    // Get form data
    function getFormData() {
        return {
            asset: document.getElementById('asset').value,
            timeframe: document.getElementById('timeframe').value,
            confidence_threshold: parseFloat(document.getElementById('confidence-threshold').value),
            model_type: document.getElementById('model-type').value || null,
            include_technical: {
                rsi: document.getElementById('include-rsi').checked,
                macd: document.getElementById('include-macd').checked,
                bollinger: document.getElementById('include-bb').checked
            },
            risk_tolerance: document.getElementById('risk-tolerance').value
        };
    }

    // Display prediction results
    function displayPredictionResults(recommendation, formData) {
        const resultDiv = document.getElementById('prediction-result');
        resultDiv.classList.remove('hidden');
        
        // Update action badge
        updateActionBadge(recommendation.action);
        
        // Update reason
        document.getElementById('recommendation-reason').textContent = 
            recommendation.reason || `Analysis for ${formData.asset} over ${formData.timeframe}`;
        
        // Update metrics
        document.getElementById('current-price').textContent = formatCurrency(recommendation.current_price);
        document.getElementById('predicted-price').textContent = formatCurrency(recommendation.predicted_price);
        document.getElementById('prediction-timeframe').textContent = formData.timeframe;
        
        const priceMovement = recommendation.price_movement;
        const priceElement = document.getElementById('price-movement');
        priceElement.textContent = priceMovement;
        addPriceChangeClass(priceElement, parseFloat(priceMovement));
        
        // Update confidence
        const confidence = recommendation.confidence || 50;
        document.getElementById('confidence').textContent = `${confidence}%`;
        animateProgressBar('confidence-bar', confidence);
        
        // Update risk assessment
        updateRiskAssessment(recommendation);
        
        // Update model performance
        updateModelPerformanceDisplay(recommendation.model_performance);
        
        // Update technical analysis
        updateTechnicalAnalysis(recommendation, formData);
        
        // Scroll to results
        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Update action badge
    function updateActionBadge(action) {
        const badge = document.getElementById('action-badge');
        const actionColors = {
            'BUY': 'bg-green-500',
            'SELL': 'bg-red-500', 
            'HOLD': 'bg-yellow-500'
        };
        
        badge.textContent = action;
        badge.className = `px-6 py-3 rounded-full text-white font-bold text-xl ${actionColors[action] || 'bg-gray-500'}`;
    }

    // Update risk assessment
    function updateRiskAssessment(recommendation) {
        const riskLevel = recommendation.risk_level || 'MEDIUM';
        const riskColors = {
            'LOW': 'bg-green-100 text-green-800',
            'MEDIUM': 'bg-yellow-100 text-yellow-800',
            'HIGH': 'bg-red-100 text-red-800'
        };
        
        const riskElement = document.getElementById('risk-level');
        riskElement.textContent = riskLevel;
        riskElement.className = `px-2 py-1 rounded text-xs font-medium ${riskColors[riskLevel] || 'bg-gray-100 text-gray-800'}`;
        
        document.getElementById('risk-range').textContent = recommendation.risk_range || 'N/A';
        document.getElementById('drawdown-risk').textContent = calculateDrawdownRisk(recommendation);
    }

    // Calculate drawdown risk (simplified)
    function calculateDrawdownRisk(recommendation) {
        const priceChange = parseFloat(recommendation.price_movement) || 0;
        const absChange = Math.abs(priceChange);
        
        if (absChange > 10) return 'High';
        if (absChange > 5) return 'Medium';
        return 'Low';
    }

    // Update model performance display
    function updateModelPerformanceDisplay(performance) {
        if (!performance) return;
        
        document.getElementById('model-r2').textContent = 
            performance.r2_score ? performance.r2_score.toFixed(3) : 'N/A';
        document.getElementById('model-cv-mean').textContent = 
            performance.cv_mean ? performance.cv_mean.toFixed(3) : 'N/A';
        document.getElementById('model-cv-std').textContent = 
            performance.cv_std ? `±${performance.cv_std.toFixed(3)}` : 'N/A';
    }

    // Update technical analysis
    function updateTechnicalAnalysis(recommendation, formData) {
        // Simulate technical signals (in real app, these would come from API)
        const signals = generateTechnicalSignals(recommendation, formData);
        
        document.getElementById('tech-rsi').textContent = signals.rsi;
        document.getElementById('tech-macd').textContent = signals.macd;
        document.getElementById('tech-trend').textContent = signals.trend;
    }

    // Generate technical signals (simplified)
    function generateTechnicalSignals(recommendation, formData) {
        const priceChange = parseFloat(recommendation.price_movement) || 0;
        
        return {
            rsi: priceChange > 2 ? 'Overbought' : priceChange < -2 ? 'Oversold' : 'Neutral',
            macd: priceChange > 0 ? 'Bullish' : 'Bearish',
            trend: priceChange > 1 ? 'Uptrend' : priceChange < -1 ? 'Downtrend' : 'Sideways'
        };
    }

    // Event handlers
    function toggleAdvancedOptions() {
        const options = document.getElementById('advanced-options');
        const toggle = document.getElementById('advanced-toggle');
        
        if (options.classList.contains('hidden')) {
            options.classList.remove('hidden');
            toggle.classList.add('rotate-180');
        } else {
            options.classList.add('hidden');
            toggle.classList.remove('rotate-180');
        }
    }

    function updateComparisonChart() {
        const metric = document.getElementById('comparison-metric').value;
        showToast(`Updating comparison chart for ${metric}`, 'info');
        updateModelComparisonChart(modelData);
    }

    // Model actions
    async function trainModel(targetCol) {
        try {
            showToast(`Starting enhanced training for ${targetCol}...`, 'info');
            
            const response = await apiCall('/api/model/train', {
                method: 'POST',
                body: JSON.stringify({
                    target_col: targetCol,
                    optimize_params: true,
                    test_size: 0.2
                })
            });
            
            if (response.success) {
                showToast(`${targetCol} model trained successfully!`, 'success');
                setTimeout(() => {
                    loadModelPerformance(); // Refresh display
                }, 1000);
            }
            
        } catch (error) {
            console.error(`Training error for ${targetCol}:`, error);
            showToast(`Failed to train ${targetCol} model: ${error.message}`, 'error');
        }
    }

    function viewModelDetails(asset) {
        showToast(`Detailed ${asset} model information would open here`, 'info');
        // In real app, this would open a modal with comprehensive model details
    }

    function compareModels() {
        showToast('Model comparison feature activated', 'info');
        // Scroll to comparison chart
        document.getElementById('modelComparisonChart').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }

    function refreshModelData() {
        loadModelPerformance();
    }

    // Prediction action handlers
    function viewPredictionChart() {
        showToast('Prediction chart visualization would open here', 'info');
    }

    function runBacktest() {
        showToast('Running backtesting simulation...', 'info');
        setTimeout(() => {
            showToast('Backtest complete! Results would be displayed here.', 'success');
        }, 3000);
    }

    function exportPrediction() {
        showToast('Exporting prediction report...', 'info');
        setTimeout(() => {
            showToast('Prediction report exported successfully!', 'success');
        }, 1500);
    }

    function schedulePrediction() {
        showToast('Prediction scheduling feature would open here', 'info');
    }

    // Helper function to set loading state
    function setLoadingState(asset, message) {
        const elements = ['r2', 'rmse', 'mae', 'cv'];
        elements.forEach(metric => {
            const element = document.getElementById(`${asset}-${metric}`);
            if (element) {
                element.textContent = message || 'N/A';
            }
        });
    }
</script>
{% endblock %}
