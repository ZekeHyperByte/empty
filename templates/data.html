{% extends "base.html" %}

{% block title %}Data - Gold and Bitcoin Predictor{% endblock %}

{% block content %}
<div class="bg-white shadow-md rounded-lg overflow-hidden">
    <div class="p-8">
        <!-- Header Section -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-database mr-3 text-blue-600"></i>
                    Enhanced Data Exploration
                </h1>
                <p class="text-gray-600">
                    Comprehensive analysis of financial market data with enhanced statistics, visualizations, and quality assessments
                </p>
            </div>
            <div class="flex gap-3">
                <button id="refresh-data" onclick="refreshDataAnalysis()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 btn-enhanced">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
                <button onclick="exportDataReport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 btn-enhanced">
                    <i class="fas fa-download mr-2"></i>Export Report
                </button>
                <button onclick="showDataQuality()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 btn-enhanced">
                    <i class="fas fa-check-circle mr-2"></i>Data Quality
                </button>
            </div>
        </div>

        <!-- Data Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <!-- Dataset Info Card -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg shadow-lg card-hover border border-blue-200">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-800">Dataset Overview</h3>
                    <i class="fas fa-table text-2xl text-blue-600"></i>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Total Records:</span>
                        <span id="total-records" class="font-medium">Loading...</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Features:</span>
                        <span id="total-features" class="font-medium">Loading...</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Date Range:</span>
                        <span id="date-range" class="font-medium text-xs">Loading...</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Quality Score:</span>
                        <span id="quality-score" class="font-medium">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Completeness Card -->
            <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg shadow-lg card-hover border border-green-200">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-800">Data Completeness</h3>
                    <i class="fas fa-chart-pie text-2xl text-green-600"></i>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-700 mb-1" id="completeness-percentage">Loading...</div>
                    <div class="text-sm text-gray-600 mb-3">Complete Records</div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="completeness-bar" class="bg-green-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Missing Data Card -->
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-lg shadow-lg card-hover border border-yellow-200">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-800">Missing Values</h3>
                    <i class="fas fa-exclamation-triangle text-2xl text-yellow-600"></i>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Total Missing:</span>
                        <span id="total-missing" class="font-medium">Loading...</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Worst Column:</span>
                        <span id="worst-column" class="font-medium text-xs">Loading...</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Missing %:</span>
                        <span id="missing-percentage" class="font-medium">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Data Health Card -->
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg shadow-lg card-hover border border-purple-200">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-800">Data Health</h3>
                    <i class="fas fa-heartbeat text-2xl text-purple-600"></i>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Outliers:</span>
                        <span id="outlier-count" class="font-medium">Loading...</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Duplicates:</span>
                        <span id="duplicate-count" class="font-medium">Loading...</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Health Status:</span>
                        <span id="health-status" class="px-2 py-1 rounded text-xs font-medium">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Data Controls -->
        <div class="bg-gray-50 p-4 rounded-lg shadow mb-6">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">View Mode:</label>
                    <select id="view-mode" onchange="updateViewMode()" class="form-enhanced rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-sm">
                        <option value="summary">Summary Statistics</option>
                        <option value="detailed">Detailed Analysis</option>
                        <option value="correlation">Correlation Matrix</option>
                        <option value="distribution">Distribution Analysis</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Asset Focus:</label>
                    <select id="asset-filter" onchange="updateAssetFilter()" class="form-enhanced rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-sm">
                        <option value="all">All Assets</option>
                        <option value="gold">Gold Only</option>
                        <option value="bitcoin">Bitcoin Only</option>
                        <option value="indices">Market Indices</option>
                        <option value="commodities">Commodities</option>
                    </select>
                </div>

                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Show Technical Features:</label>
                    <label class="flex items-center">
                        <input type="checkbox" id="show-technical" onchange="toggleTechnicalFeatures()" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                        <span class="ml-1 text-sm">Include Enhanced Features</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content">
            <!-- Dataset Information Panel -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Basic Dataset Info -->
                <div class="bg-gray-50 p-6 rounded-lg shadow card-hover">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-info-circle mr-2 text-blue-600"></i>Dataset Information
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="text-sm font-medium text-gray-700">Dataset Shape:</span>
                            <span id="dataset-shape" class="text-sm text-gray-600">Loading...</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="text-sm font-medium text-gray-700">Memory Usage:</span>
                            <span id="memory-usage" class="text-sm text-gray-600">Loading...</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="text-sm font-medium text-gray-700">File Size:</span>
                            <span id="file-size" class="text-sm text-gray-600">Loading...</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="text-sm font-medium text-gray-700">Last Updated:</span>
                            <span id="last-updated" class="text-sm text-gray-600">Loading...</span>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="font-medium text-gray-700 mb-2">Available Columns:</h3>
                        <div id="column-list" class="flex flex-wrap gap-2">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Data Quality Assessment -->
                <div class="bg-gray-50 p-6 rounded-lg shadow card-hover">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-shield-alt mr-2 text-green-600"></i>Data Quality Assessment
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Completeness Score -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Completeness</span>
                                <span id="completeness-score" class="text-sm font-medium">Loading...</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="completeness-progress" class="bg-green-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Consistency Score -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Consistency</span>
                                <span id="consistency-score" class="text-sm font-medium">Loading...</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="consistency-progress" class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Validity Score -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Validity</span>
                                <span id="validity-score" class="text-sm font-medium">Loading...</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="validity-progress" class="bg-purple-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Overall Quality -->
                        <div class="pt-2 border-t border-gray-200">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-700">Overall Quality</span>
                                <span id="overall-quality" class="px-3 py-1 rounded text-sm font-medium">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Missing Values Analysis -->
            <div class="bg-gray-50 p-6 rounded-lg shadow mb-8 card-hover">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-search mr-2 text-red-600"></i>Missing Values Analysis
                    </h2>
                    <button onclick="showMissingValueDetails()" class="text-sm bg-red-100 text-red-800 px-3 py-1 rounded hover:bg-red-200 transition-colors duration-200">
                        <i class="fas fa-eye mr-1"></i>Detailed View
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Column</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Data Type</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Missing Count</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Missing %</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Quality</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="missing-values-table">
                            <tr>
                                <td colspan="6" class="py-4 px-4 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Loading missing values analysis...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Summary Statistics Panel -->
            <div class="bg-gray-50 p-6 rounded-lg shadow mb-8 card-hover">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-chart-bar mr-2 text-purple-600"></i>Enhanced Summary Statistics
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="downloadSummary()" class="text-sm bg-purple-100 text-purple-800 px-3 py-1 rounded hover:bg-purple-200 transition-colors duration-200">
                            <i class="fas fa-download mr-1"></i>Download
                        </button>
                        <button onclick="comparePeriods()" class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 transition-colors duration-200">
                            <i class="fas fa-calendar mr-1"></i>Compare Periods
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Statistic</th>
                                <th id="stats-headers" class="text-left py-3 px-4 font-medium text-gray-700">
                                    <!-- Column headers populated by JavaScript -->
                                </th>
                            </tr>
                        </thead>
                        <tbody id="summary-statistics-table">
                            <tr>
                                <td colspan="10" class="py-4 px-4 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Loading summary statistics...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Data Distribution Visualization -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Distribution Chart -->
                <div class="bg-gray-50 p-6 rounded-lg shadow card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">
                            <i class="fas fa-chart-area mr-2 text-green-600"></i>Data Distribution
                        </h2>
                        <select id="distribution-column" onchange="updateDistributionChart()" class="form-enhanced rounded border-gray-300 text-sm">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                    <div class="mt-4 text-sm text-gray-600">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="font-medium" id="dist-mean">--</div>
                                <div class="text-xs">Mean</div>
                            </div>
                            <div>
                                <div class="font-medium" id="dist-median">--</div>
                                <div class="text-xs">Median</div>
                            </div>
                            <div>
                                <div class="font-medium" id="dist-std">--</div>
                                <div class="text-xs">Std Dev</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Correlation Heatmap -->
                <div class="bg-gray-50 p-6 rounded-lg shadow card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">
                            <i class="fas fa-th mr-2 text-orange-600"></i>Correlation Matrix
                        </h2>
                        <button onclick="viewFullCorrelation()" class="text-sm bg-orange-100 text-orange-800 px-3 py-1 rounded hover:bg-orange-200 transition-colors duration-200">
                            <i class="fas fa-expand mr-1"></i>Expand
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="correlationHeatmap"></canvas>
                    </div>
                    <div class="mt-4 text-sm text-gray-600">
                        <div class="flex justify-between">
                            <span>Strongest Correlation: <span id="strongest-corr" class="font-medium">Loading...</span></span>
                            <span>Weakest Correlation: <span id="weakest-corr" class="font-medium">Loading...</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Data Insights -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg shadow mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Enhanced Data Insights
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <h3 class="font-medium text-gray-700 mb-2">Data Quality Issues:</h3>
                        <ul class="text-sm text-gray-600 space-y-1" id="quality-issues">
                            <li><i class="fas fa-spinner fa-spin mr-2"></i>Analyzing data quality...</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-700 mb-2">Key Findings:</h3>
                        <ul class="text-sm text-gray-600 space-y-1" id="key-findings">
                            <li><i class="fas fa-spinner fa-spin mr-2"></i>Generating insights...</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-700 mb-2">Recommendations:</h3>
                        <ul class="text-sm text-gray-600 space-y-1" id="recommendations">
                            <li><i class="fas fa-spinner fa-spin mr-2"></i>Preparing recommendations...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center gap-4">
            <a href="{{ url_for('analytics') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 btn-enhanced">
                <i class="fas fa-chart-line mr-2"></i>Continue to Analytics
            </a>
            <button onclick="generateDataReport()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 btn-enhanced">
                <i class="fas fa-file-alt mr-2"></i>Generate Full Report
            </button>
            <button onclick="exportCleanData()" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 btn-enhanced">
                <i class="fas fa-broom mr-2"></i>Export Clean Data
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let distributionChart, correlationHeatmap;
    let dataStats = {};
    let currentData = {};

    // Initialize data exploration page
    document.addEventListener('DOMContentLoaded', function() {
        loadDataAnalysis();
        initializeCharts();
        
        // Auto-refresh every 10 minutes
        setInterval(refreshDataAnalysis, 600000);
    });

    // Load comprehensive data analysis
    async function loadDataAnalysis() {
        try {
            showLoading('refresh-data', 'Loading Data...');
            
            const response = await apiCall('/api/data/summary');
            
            if (response.success) {
                currentData = response.data;
                updateDataOverview(response.data);
                updateDataQuality(response.data);
                updateMissingValuesTable(response.data);
                updateSummaryStatistics(response.data);
                updateDataInsights(response.data);
                populateColumnSelectors(response.data);
            }
            
            hideLoading('refresh-data');
            showToast('Data analysis completed successfully', 'success');
            
        } catch (error) {
            console.error('Failed to load data analysis:', error);
            hideLoading('refresh-data');
            showToast('Failed to load data analysis', 'error');
        }
    }

    // Update data overview cards
    function updateDataOverview(data) {
        // Basic dataset info
        if (data.basic_info) {
            const shape = data.basic_info.shape;
            document.getElementById('total-records').textContent = shape ? shape[0].toLocaleString() : 'N/A';
            document.getElementById('total-features').textContent = shape ? shape[1] : 'N/A';
            document.getElementById('dataset-shape').textContent = shape ? `${shape[0]} Ã— ${shape[1]}` : 'N/A';
        }

        // Date range
        if (data.date_range) {
            const dateRange = `${data.date_range.start} to ${data.date_range.end}`;
            document.getElementById('date-range').textContent = dateRange;
        }

        // Calculate and display quality metrics
        const qualityMetrics = calculateQualityMetrics(data);
        updateQualityDisplays(qualityMetrics);

        // Memory and file info (simulated)
        document.getElementById('memory-usage').textContent = estimateMemoryUsage(data);
        document.getElementById('file-size').textContent = estimateFileSize(data);
        document.getElementById('last-updated').textContent = new Date().toLocaleDateString();
    }

    // Calculate comprehensive quality metrics
    function calculateQualityMetrics(data) {
        let totalCells = 0;
        let missingCells = 0;
        let columns = [];

        if (data.missing_values) {
            columns = Object.keys(data.missing_values);
            const recordCount = data.basic_info?.shape?.[0] || 1000; // Fallback

            columns.forEach(col => {
                totalCells += recordCount;
                missingCells += data.missing_values[col] || 0;
            });
        }

        const completeness = totalCells > 0 ? ((totalCells - missingCells) / totalCells) * 100 : 100;
        const consistency = Math.max(85, 100 - (missingCells / 100)); // Simplified
        const validity = Math.max(90, 100 - (missingCells / 200)); // Simplified

        return {
            completeness,
            consistency,
            validity,
            totalMissing: missingCells,
            totalCells,
            columns
        };
    }

    // Update quality displays
    function updateQualityDisplays(metrics) {
        // Completeness
        const completeness = Math.round(metrics.completeness);
        document.getElementById('completeness-percentage').textContent = `${completeness}%`;
        animateProgressBar('completeness-bar', completeness);
        document.getElementById('completeness-score').textContent = `${completeness}%`;
        animateProgressBar('completeness-progress', completeness);

        // Consistency
        const consistency = Math.round(metrics.consistency);
        document.getElementById('consistency-score').textContent = `${consistency}%`;
        animateProgressBar('consistency-progress', consistency);

        // Validity
        const validity = Math.round(metrics.validity);
        document.getElementById('validity-score').textContent = `${validity}%`;
        animateProgressBar('validity-progress', validity);

        // Overall quality
        const overall = Math.round((completeness + consistency + validity) / 3);
        const qualityElement = document.getElementById('overall-quality');
        const qualityScoreElement = document.getElementById('quality-score');
        
        let qualityClass, qualityText;
        if (overall >= 90) {
            qualityClass = 'bg-green-100 text-green-800';
            qualityText = 'Excellent';
        } else if (overall >= 75) {
            qualityClass = 'bg-blue-100 text-blue-800';
            qualityText = 'Good';
        } else if (overall >= 60) {
            qualityClass = 'bg-yellow-100 text-yellow-800';
            qualityText = 'Fair';
        } else {
            qualityClass = 'bg-red-100 text-red-800';
            qualityText = 'Poor';
        }

        qualityElement.textContent = qualityText;
        qualityElement.className = `px-3 py-1 rounded text-sm font-medium ${qualityClass}`;
        qualityScoreElement.textContent = `${overall}%`;

        // Missing data summary
        document.getElementById('total-missing').textContent = metrics.totalMissing.toLocaleString();
        document.getElementById('missing-percentage').textContent = `${(100 - completeness).toFixed(1)}%`;

        // Find worst column
        if (currentData.missing_values) {
            const worstCol = Object.entries(currentData.missing_values)
                .sort(([,a], [,b]) => b - a)[0];
            document.getElementById('worst-column').textContent = worstCol ? worstCol[0] : 'None';
        }

        // Health metrics
        document.getElementById('outlier-count').textContent = estimateOutliers(currentData);
        document.getElementById('duplicate-count').textContent = '0'; // Assume no duplicates
        
        const healthElement = document.getElementById('health-status');
        healthElement.textContent = overall >= 80 ? 'Healthy' : overall >= 60 ? 'Fair' : 'Needs Attention';
        healthElement.className = `px-2 py-1 rounded text-xs font-medium ${
            overall >= 80 ? 'bg-green-100
